<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPACE TERMINAL | PRECISE L1 MONITOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #020205; 
            --panel: rgba(13, 13, 25, 0.96);
            --neon-blue: #00f3ff; 
            --neon-green: #00ff88;
            --neon-red: #ff3366; 
            --neon-yellow: #ffcc00;
            --glass-border: rgba(0, 243, 255, 0.2);
        }

        body { 
            background: var(--bg-dark); 
            color: #fff; 
            margin: 0; 
            font-family: 'Exo 2', sans-serif; 
            overflow-x: hidden; 
        }

        canvas#starfield { 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: -1; 
            pointer-events: none; 
        }

        .header-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 40px; 
            background: rgba(0,0,0,0.95); 
            border-bottom: 1px solid var(--glass-border); 
            position: sticky; 
            top: 0; 
            z-index: 100;
        }

        .nav-logo { 
            font-family: 'Rajdhani'; 
            font-weight: 700; 
            letter-spacing: 3px; 
            color: #fff; 
            text-decoration: none; 
            font-size: 1.2rem; 
        }

        .status-box { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }

        .status-badge { 
            font-size: 0.7rem; 
            color: var(--neon-blue); 
            border: 1px solid var(--neon-blue); 
            padding: 4px 12px; 
            border-radius: 4px; 
            font-weight: bold; 
            text-transform: uppercase; 
        }

        .dashboard { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
            display: grid; 
            gap: 20px; 
        }

        .top-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }

        .main-card { 
            background: var(--panel); 
            border: 1px solid var(--glass-border); 
            padding: 25px; 
            text-align: center; 
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.05);
        }

        .main-label { 
            font-size: 0.7rem; 
            color: #888; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            margin-bottom: 5px; 
        }

        .main-value { 
            font-family: 'Rajdhani'; 
            font-size: 4rem; 
            font-weight: 700; 
            line-height: 1; 
            margin: 10px 0; 
        }

        .main-sub { 
            font-weight: 700; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
        }

        .chart-item { 
            background: var(--panel); 
            border: 1px solid rgba(255,255,255,0.05); 
            padding: 20px; 
            border-radius: 12px; 
            height: 320px; 
        }

        .chart-info { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-family: 'Rajdhani'; 
            color: #aaa; 
            font-size: 0.8rem; 
        }

        .visual-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 10px; 
        }

        .visual-card { 
            background: var(--panel); 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border); 
            text-align: center; 
        }

        .visual-card img { 
            width: 100%; 
            border-radius: 8px; 
            margin-top: 10px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }

        @media (max-width: 768px) { 
            .top-row, .charts-grid, .visual-grid { grid-template-columns: 1fr; } 
            .header-nav { padding: 10px 20px; } 
            .main-value { font-size: 3rem; } 
        }

        #footer-status { 
            text-align: center; 
            font-size: 0.65rem; 
            color: #666; 
            padding: 20px; 
            font-family: monospace; 
        }

        .heartbeat { 
            display: inline-block; 
            width: 8px; 
            height: 8px; 
            background: var(--neon-green); 
            border-radius: 50%; 
            margin-right: 8px; 
        }

        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>
    
    <div class="header-nav">
        <a href="#" class="nav-logo">WEB SPACE STATION</a>
        <div class="status-box">
            <div id="sync-indicator" class="heartbeat"></div>
            <div class="status-badge">LIVE: DSCOVR L1</div>
        </div>
    </div>

    <div class="dashboard">
        <div class="top-row">
            <div class="main-card">
                <div class="main-label">Indeks Geomagnetyczny (Kp)</div>
                <div id="kp-val" class="main-value">--</div>
                <div id="kp-stat" class="main-sub">POBIERANIE...</div>
            </div>
            
            <div class="main-card" style="border-color: var(--neon-yellow);">
                <div class="main-label">Czas dolotu do Ziemi (ETA)</div>
                <div id="eta-val" class="main-value" style="color: var(--neon-yellow);">-- min</div>
                <div id="eta-desc" class="main-sub" style="color: #666;">ANALIZA STRUMIENIA...</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-item">
                <div class="chart-info"><span>Prędkość Wiatru</span><span id="v-wind" style="color:var(--neon-yellow)">-- km/s</span></div>
                <canvas id="chart-wind"></canvas>
            </div>
            
            <div class="chart-item">
                <div class="chart-info"><span>Pole Magnetyczne Bz</span><span id="v-bz" style="color:var(--neon-red)">-- nT</span></div>
                <canvas id="chart-bz"></canvas>
            </div>
            
            <div class="chart-item">
                <div class="chart-info"><span>Gęstość Protonów</span><span id="v-dens" style="color:var(--neon-green)">-- p/cm³</span></div>
                <canvas id="chart-dens"></canvas>
            </div>
            
            <div class="chart-item">
                <div class="chart-info"><span>Temperatura Plazmy</span><span id="v-temp" style="color:var(--neon-blue)">-- °C</span></div>
                <canvas id="chart-temp"></canvas>
            </div>
        </div>

        <div class="visual-grid">
            <div class="visual-card">
                <div class="main-label">Prognoza Zorzy (Północ)</div>
                <img id="img-aurora" src="https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg">
            </div>
            
            <div class="visual-card">
                <div class="main-label">Słońce: SOHO / SDO Live</div>
                <img id="img-sun" src="https://sohowww.nascom.nasa.gov/data/realtime/hmi_mag/512/latest.jpg">
            </div>
        </div>

        <div id="footer-status">
            STATUS SYSTEMU: <span id="link-status" style="color:var(--neon-green)">OPERACYJNY</span> // 
            OSTATNIA SYNCHRONIZACJA: <span id="last-sync">--:--:--</span> // 
            KOLEJNE ODSWIEŻENIE ZA: <span id="next-sync" style="color:var(--neon-blue)">15</span>s
        </div>
    </div>

    <script src="stars.js"></script>
    <script>
        const proxy = "https://api.allorigins.win/get?url=";
        const L1_DIST = 1485000; 
        let timeLeft = 15;

        // --- PLUGIN RYSUJĄCY LINIĘ UDERZENIA W ZIEMIĘ ---
        const earthLinePlugin = {
            id: 'earthLine',
            afterDraw: (chart) => {
                if (!chart.data.labels || !chart.data.labels.length || !chart.currentWind) return;
                
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                
                // Obliczamy ile minut temu wiatr, który jest TERAZ na ziemi, minął satelitę
                const travelTimeMin = (L1_DIST / chart.currentWind) / 60;
                
                // W danych 2h od NOAA, każdy punkt to zazwyczaj 1 minuta
                const impactIndex = chart.data.labels.length - 1 - Math.round(travelTimeMin);
                
                if (impactIndex >= 0) {
                    const x = xAxis.getPixelForValue(impactIndex);
                    const ctx = chart.ctx;
                    
                    ctx.save();
                    ctx.setLineDash([5, 5]);
                    ctx.strokeStyle = 'rgba(0, 243, 255, 0.9)';
                    ctx.lineWidth = 2;
                    
                    // Rysowanie pionowej linii
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.stroke();
                    
                    // Etykieta tekstowa (wyżej, żeby nie zasłaniać linii wykresu)
                    ctx.fillStyle = '#00f3ff';
                    ctx.font = 'bold 11px Rajdhani';
                    ctx.textAlign = 'center';
                    ctx.fillText('TERAZ NA ZIEMI', x, yAxis.top + 15);
                    ctx.restore();
                }
            }
        };
        Chart.register(earthLinePlugin);

        // --- FUNKCJA TWORZĄCA WYKRESY ---
        function createChart(id, color) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        data: [], 
                        borderColor: color, 
                        borderWidth: 2, 
                        fill: false, 
                        tension: 0.1, 
                        pointRadius: 0 
                    }] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#555', font: { size: 9 }, maxTicksLimit: 6 }, 
                            grid: { display: false } 
                        },
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#777', font: { size: 10 } },
                            beginAtZero: false // KLUCZOWE DLA AUTOSKALOWANIA Bz
                        }
                    }
                }
            });
        }

        const charts = { 
            wind: createChart('chart-wind', '#ffcc00'), 
            bz: createChart('chart-bz', '#ff3366'), 
            dens: createChart('chart-dens', '#00ff88'), 
            temp: createChart('chart-temp', '#00f3ff') 
        };

        // --- LOGIKA POBIERANIA DANYCH ---
        async function update() {
            document.getElementById('sync-indicator').classList.add('blink');
            
            try {
                const [pRaw, mRaw, kRaw] = await Promise.all([
                    fetch(proxy + encodeURIComponent("https://services.swpc.noaa.gov/products/solar-wind/plasma-2-hour.json")).then(r => r.json()),
                    fetch(proxy + encodeURIComponent("https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json")).then(r => r.json()),
                    fetch(proxy + encodeURIComponent("https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json")).then(r => r.json())
                ]);

                const plasma = JSON.parse(pRaw.contents);
                const mag = JSON.parse(mRaw.contents);
                const kp = JSON.parse(kRaw.contents);

                // Przygotowanie etykiet czasowych
                const labels = plasma.slice(1).map(d => {
                    const t = new Date(d[0]);
                    return t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
                });

                const curWind = parseFloat(plasma[plasma.length-1][2]);
                const travelMin = Math.floor((L1_DIST / curWind) / 60);

                // Masowe odświeżanie wykresów
                const refresh = (chart, data) => {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = data;
                    chart.currentWind = curWind;
                    chart.update();
                };

                refresh(charts.wind, plasma.slice(1).map(d => parseFloat(d[2])));
                refresh(charts.bz, mag.slice(1).map(d => parseFloat(d[3])));
                refresh(charts.dens, plasma.slice(1).map(d => parseFloat(d[1])));
                refresh(charts.temp, plasma.slice(1).map(d => Math.round(parseFloat(d[3]) - 273.15)));

                // Aktualizacja liczników tekstowych
                document.getElementById('v-wind').innerText = Math.round(curWind) + " km/s";
                document.getElementById('v-bz').innerText = parseFloat(mag[mag.length-1][3]).toFixed(2) + " nT";
                document.getElementById('v-dens').innerText = parseFloat(plasma[plasma.length-1][1]).toFixed(1) + " p/cm³";
                document.getElementById('v-temp').innerText = Math.round(parseFloat(plasma[plasma.length-1][3]) - 273.15).toLocaleString() + " °C";
                document.getElementById('eta-val').innerText = travelMin + " min";
                
                // Kp Index i status
                const kVal = parseFloat(kp[kp.length-1][1]);
                document.getElementById('kp-val').innerText = kVal.toFixed(2);
                const s = document.getElementById('kp-stat');
                
                if(kVal >= 5) {
                    s.innerText = "BURZA GEOMAGNETYCZNA";
                    s.style.color = 'var(--neon-red)';
                } else if(kVal >= 4) {
                    s.innerText = "WARUNKI NIEPOKOJU";
                    s.style.color = 'var(--neon-yellow)';
                } else {
                    s.innerText = "SPOKOJNIE";
                    s.style.color = 'var(--neon-green)';
                }

                // Odświeżanie obrazów z timestampem (bypass cache)
                const ts = Date.now();
                document.getElementById('img-aurora').src = "https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg?t=" + ts;
                document.getElementById('img-sun').src = "https://sohowww.nascom.nasa.gov/data/realtime/hmi_mag/512/latest.jpg?t=" + ts;
                
                document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
                document.getElementById('link-status').innerText = "OPERACYJNY";
                document.getElementById('link-status').style.color = "var(--neon-green)";
                timeLeft = 15;

            } catch (err) {
                console.error("Data Link Error:", err);
                document.getElementById('link-status').innerText = "BŁĄD POŁĄCZENIA";
                document.getElementById('link-status').style.color = "var(--neon-red)";
            }
            
            setTimeout(() => document.getElementById('sync-indicator').classList.remove('blink'), 2000);
        }

        // Pętla odliczania
        setInterval(() => {
            timeLeft--;
            if(timeLeft < 0) timeLeft = 0;
            document.getElementById('next-sync').innerText = timeLeft;
        }, 1000);

        // Start i interwał główny
        update();
        setInterval(update, 15000);
    </script>
</body>
</html>
