<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEB SPACE STATION | TERMINAL L1 PRECISION</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #020205; --panel: rgba(13, 13, 25, 0.96);
            --neon-blue: #00f3ff; --neon-green: #00ff88;
            --neon-red: #ff3366; --neon-yellow: #ffcc00;
        }
        body { background: var(--bg-dark); color: #fff; margin: 0; font-family: 'Exo 2', sans-serif; overflow-x: hidden; }
        canvas#starfield { position: fixed; top: 0; left: 0; z-index: -1; }
        .dashboard { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }
        .main-card { background: var(--panel); border: 1px solid rgba(0, 243, 255, 0.2); padding: 20px; text-align: center; border-radius: 12px; }
        .main-value { font-family: 'Rajdhani'; font-size: 4rem; font-weight: 700; line-height: 1; margin: 5px 0; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
        .chart-card { background: var(--panel); padding: 20px; border-radius: 12px; height: 350px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .label-text { font-size: 0.75rem; color: #888; letter-spacing: 2px; text-transform: uppercase; }
        #footer-status { text-align: center; font-size: 0.65rem; color: #444; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>
    <div class="dashboard">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="main-card">
                <div class="label-text">INDEKS KP</div>
                <div id="kp-val" class="main-value">--</div>
                <div id="kp-stat" style="font-size:0.8rem; font-weight:bold">ŁĄCZENIE...</div>
            </div>
            <div class="main-card" style="border-color: var(--neon-yellow);">
                <div class="label-text">DOLOT DO ZIEMI (ETA)</div>
                <div id="eta-val" class="main-value" style="color: var(--neon-yellow);">-- min</div>
                <div id="eta-desc" style="font-size:0.8rem; color:#666">KALIBRACJA...</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card"><div class="label-text">Wiatr Słoneczny (km/s)</div><canvas id="windChart"></canvas></div>
            <div class="chart-card"><div class="label-text">Pole Magnetyczne Bz (nT)</div><canvas id="bzChart"></canvas></div>
            <div class="chart-card"><div class="label-text">Gęstość (p/cm³)</div><canvas id="densChart"></canvas></div>
            <div class="chart-card"><div class="label-text">Temperatura (°C)</div><canvas id="tempChart"></canvas></div>
        </div>
        <div id="footer-status">Terminal Ready. Waiting for satellite sync...</div>
    </div>

    <script src="stars.js"></script>
    <script>
        const proxies = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?",
            "https://thingproxy.freeboard.io/fetch/"
        ];
        let currentProxyIdx = 0;
        const L1_DIST = 1500000;

        // Plugin rysujący linię Ziemi w poprawnym miejscu historycznym
        const earthLinePlugin = {
            id: 'earthLine',
            afterDraw: (chart) => {
                if (!chart.data.datasets[0].data.length) return;
                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;
                
                // Obliczamy cofnięcie: ile minut temu ten wiatr minął L1?
                const windSpeed = chart.currentWind || 400;
                const travelMinutes = Math.floor((L1_DIST / windSpeed) / 60);
                
                // Szukamy indeksu na osi czasu (dane są co 1 min)
                const earthIdx = chart.data.labels.length - 1 - travelMinutes;

                if (earthIdx >= 0) {
                    const x = xAxis.getPixelForValue(earthIdx);
                    ctx.save();
                    ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = '#00f3ff';
                    ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(x, yAxis.top); ctx.lineTo(x, yAxis.bottom); ctx.stroke();
                    
                    ctx.fillStyle = '#00f3ff'; ctx.font = 'bold 10px Rajdhani';
                    ctx.textAlign = 'right'; ctx.fillText('ZIEMIA (TERAZ)', x - 5, yAxis.top + 15);
                    ctx.restore();
                }
            }
        };
        Chart.register(earthLinePlugin);

        function makeChart(id, color) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#444', font: { size: 9 }, maxTicksLimit: 10 }, grid: { display: false } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                    }
                }
            });
        }

        const charts = {
            wind: makeChart('windChart', '#ffcc00'),
            bz: makeChart('bzChart', '#ff3366'),
            dens: makeChart('densChart', '#00ff88'),
            temp: makeChart('tempChart', '#00f3ff')
        };

        async function fetchSafe(url) {
            try {
                const r = await fetch(proxies[currentProxyIdx] + encodeURIComponent(url));
                if (!r.ok) throw new Error();
                const j = await r.json();
                // Obsługa różnych formatów proxy
                return typeof j.contents === 'string' ? JSON.parse(j.contents) : (j.contents || j);
            } catch (e) {
                currentProxyIdx = (currentProxyIdx + 1) % proxies.length;
                console.warn("Proxy switch to: " + proxies[currentProxyIdx]);
                return null;
            }
        }

        async function update() {
            const plasma = await fetchSafe("https://services.swpc.noaa.gov/products/solar-wind/plasma-2-hour.json");
            const mag = await fetchSafe("https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json");
            const kp = await fetchSafe("https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json");

            if (!plasma || !mag || !kp) return;

            const labels = plasma.slice(1).map(d => {
                const t = new Date(d[0]);
                return t.getHours() + ":" + t.getMinutes().toString().padStart(2, '0');
            });

            const curWind = parseFloat(plasma[plasma.length-1][2]);
            const travelMin = Math.floor((L1_DIST / curWind) / 60);

            // Aktualizacja wykresów
            const updateChart = (chart, data, cur) => {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.currentWind = curWind;
                chart.update('none'); // 'none' dla lepszej wydajności live
            };

            updateChart(charts.wind, plasma.slice(1).map(d => parseFloat(d[2])));
            updateChart(charts.bz, mag.slice(1).map(d => parseFloat(d[3])));
            updateChart(charts.dens, plasma.slice(1).map(d => parseFloat(d[1])));
            updateChart(charts.temp, plasma.slice(1).map(d => Math.round(parseFloat(d[3]) - 273.15)));

            // Liczniki
            document.getElementById('eta-val').innerText = travelMin + " min";
            document.getElementById('kp-val').innerText = parseFloat(kp[kp.length-1][1]).toFixed(2);
            
            const kVal = parseFloat(kp[kp.length-1][1]);
            const kStat = document.getElementById('kp-stat');
            kStat.innerText = kVal >= 5 ? "BURZA MAGNETYCZNA!" : "WARUNKI STABILNE";
            kStat.style.color = kVal >= 5 ? 'var(--neon-red)' : 'var(--neon-green)';

            document.getElementById('footer-status').innerText = "LAST SYNC: " + new Date().toLocaleTimeString() + " | PROXY: " + currentProxyIdx;
        }

        update();
        setInterval(update, 60000);
    </script>
</body>
</html>
